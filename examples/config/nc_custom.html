<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Dataset Node Classification &mdash; Marius 0.0.2 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/marius_theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Python Examples" href="../python/index.html" />
    <link rel="prev" title="Small Scale Node Classification (OGBN-Arxiv)" href="nc_ogbn_arxiv.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/marius_logo_scaled.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu"> 
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Configuration Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lp_fb15k237.html">Small Scale Link Prediction (FB15K-237)</a></li>
<li class="toctree-l3"><a class="reference internal" href="lp_paleobiology.html">Paleobiology Dataset Link Prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="lp_custom.html">Custom Dataset Link Prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="nc_ogbn_arxiv.html">Small Scale Node Classification (OGBN-Arxiv)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Custom Dataset Node Classification</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#preprocess-dataset">1. Preprocess Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#define-configuration-file">2. Define Configuration File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#train-model">3. Train Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inference">4. Inference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../python/index.html">Python Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../config_interface/index.html">Configuration Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocess_datasets/index.html">Datasets and Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../export_and_inference/index.html">Model Export and Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graph_learning/index.html">Graph Learning</a></li>
</ul>


  <!-- <style>
    a.gh-font {
        font-weight: 800;
        color: rgb(160, 45, 45);
    }
    </style> -->
  <p>
  <!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000">
    <path
      d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z" />
  </svg> -->
  <a href="https://github.com/marius-team/marius">GitHub</a>
</p>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Marius</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Examples</a> &raquo;</li>
          <li><a href="index.html">Configuration Examples</a> &raquo;</li>
      <li>Custom Dataset Node Classification</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples/config/nc_custom.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="custom-dataset-node-classification">
<h1>Custom Dataset Node Classification<a class="headerlink" href="#custom-dataset-node-classification" title="Permalink to this headline"></a></h1>
<p>In this tutorial, we use the <strong>Cora dataset</strong> as an example to demonstrate a step-by-step walkthrough from preprocessing the dataset to defining the configuration file and to training <strong>a node classification with 3-layer GraphSage model</strong>.</p>
<section id="preprocess-dataset">
<h2>1. Preprocess Dataset<a class="headerlink" href="#preprocess-dataset" title="Permalink to this headline"></a></h2>
<p>Preprocessing a custom dataset is straightforward with the help of Marius python API. Preprocessing using the Marius Python API requires creating a custom Dataset class of type <code class="docutils literal notranslate"><span class="pre">NodeClassificationDataset</span></code> or <code class="docutils literal notranslate"><span class="pre">LinkPredictionDataset</span></code>. An example python script which preprocesses, trains, and evaluates the Cora dataset is provided in <code class="docutils literal notranslate"><span class="pre">examples/python/custom_nc_graphsage.py</span></code>. For detailed steps, please refer to (link).</p>
<p>Let’s borrow the provided <code class="docutils literal notranslate"><span class="pre">examples/python/custom_nc_graphsage.py</span></code> and modify it to suit our purpose. We first <code class="docutils literal notranslate"><span class="pre">download()</span></code> the dataset to <code class="docutils literal notranslate"><span class="pre">datasets/custom_nc_example/cora/</span></code>, then <code class="docutils literal notranslate"><span class="pre">preprocess()</span></code>,. Note that the <code class="docutils literal notranslate"><span class="pre">MYDATASET</span></code> class is a child class of <code class="docutils literal notranslate"><span class="pre">NodeClassificationDataset</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">marius</span> <span class="k">as</span> <span class="nn">m</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">OmegaConf</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">marius.tools.preprocess.dataset</span> <span class="kn">import</span> <span class="n">NodeClassificationDataset</span>
<span class="kn">from</span> <span class="nn">marius.tools.preprocess.utils</span> <span class="kn">import</span> <span class="n">download_url</span><span class="p">,</span> <span class="n">extract_file</span>
<span class="kn">from</span> <span class="nn">marius.tools.preprocess.converters.torch_converter</span> <span class="kn">import</span> <span class="n">TorchEdgeListConverter</span>
<span class="kn">from</span> <span class="nn">marius.tools.preprocess.converters.spark_converter</span> <span class="kn">import</span> <span class="n">SparkEdgeListConverter</span>
<span class="kn">from</span> <span class="nn">marius.tools.configuration.constants</span> <span class="kn">import</span> <span class="n">PathConstants</span>
<span class="kn">from</span> <span class="nn">marius.tools.preprocess.datasets.dataset_helpers</span> <span class="kn">import</span> <span class="n">remap_nodes</span>

<span class="k">def</span> <span class="nf">switch_to_num</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Neural_Networks&#39;</span><span class="p">,</span> <span class="s1">&#39;Rule_Learning&#39;</span><span class="p">,</span> <span class="s1">&#39;Reinforcement_Learning&#39;</span><span class="p">,</span> <span class="s1">&#39;Probabilistic_Methods&#39;</span><span class="p">,</span>\
            <span class="s1">&#39;Theory&#39;</span><span class="p">,</span> <span class="s1">&#39;Genetic_Algorithms&#39;</span><span class="p">,</span> <span class="s1">&#39;Case_Based&#39;</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">idx</span>

<span class="k">class</span> <span class="nc">MYDATASET</span><span class="p">(</span><span class="n">NodeClassificationDataset</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">spark</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">spark</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;cora&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_url</span> <span class="o">=</span> <span class="s2">&quot;http://www.cs.umd.edu/~sen/lbc-proj/data/cora.tgz&quot;</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># These are the files that I want to make my the end of the the download</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_edge_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;edge.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_node_feature_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;node-feat.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_node_label_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;node-label.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_train_nodes_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;train.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_valid_nodes_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;valid.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_test_nodes_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;test.csv&quot;</span><span class="p">)</span>

        <span class="n">download</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_edge_list_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_node_feature_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_node_label_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_train_nodes_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_valid_nodes_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_test_nodes_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="n">archive_path</span> <span class="o">=</span> <span class="n">download_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
            <span class="n">extract_file</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="n">remove_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Reading and processing the csv</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;cora/cora.content&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Getting all the indices</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">train_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
            <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
            <span class="n">test_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):]</span>

            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;train.csv&quot;</span><span class="p">),</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;valid.csv&quot;</span><span class="p">),</span> <span class="n">valid_indices</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;test.csv&quot;</span><span class="p">),</span> <span class="n">test_indices</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>


            <span class="c1"># Features</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">features</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">path_or_buf</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;node-feat.csv&quot;</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Labels</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">switch_to_num</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">path_or_buf</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;node-label.csv&quot;</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Edges</span>
            <span class="n">node_ids</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">dict_reverse</span> <span class="o">=</span> <span class="n">node_ids</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">nodes_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_reverse</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">df_edges</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;cora/cora.cites&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">df_edges</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="n">nodes_dict</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">nodes_dict</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_edges</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">path_or_buf</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;edge.csv&quot;</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_partitions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">remap_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequential_train_nodes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">partitioned_eval</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">train_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_train_nodes_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">valid_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_valid_nodes_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">test_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_test_nodes_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">converter</span> <span class="o">=</span> <span class="n">SparkEdgeListConverter</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="k">else</span> <span class="n">TorchEdgeListConverter</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="n">train_edges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_edge_list_file</span><span class="p">,</span>
            <span class="n">num_partitions</span><span class="o">=</span><span class="n">num_partitions</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">remap_ids</span><span class="o">=</span><span class="n">remap_ids</span><span class="p">,</span>
            <span class="n">sequential_train_nodes</span><span class="o">=</span><span class="n">sequential_train_nodes</span><span class="p">,</span>
            <span class="n">delim</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">known_node_ids</span><span class="o">=</span><span class="p">[</span><span class="n">train_nodes</span><span class="p">,</span> <span class="n">valid_nodes</span><span class="p">,</span> <span class="n">test_nodes</span><span class="p">],</span>
            <span class="n">partitioned_evaluation</span><span class="o">=</span><span class="n">partitioned_eval</span>
        <span class="p">)</span>
        <span class="n">dataset_stats</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_node_feature_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_node_label_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remap_ids</span><span class="p">:</span>
            <span class="n">node_mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">PathConstants</span><span class="o">.</span><span class="n">node_mapping_path</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">train_nodes</span><span class="p">,</span> <span class="n">valid_nodes</span><span class="p">,</span> <span class="n">test_nodes</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">remap_nodes</span><span class="p">(</span><span class="n">node_mapping</span><span class="p">,</span> <span class="n">train_nodes</span><span class="p">,</span> <span class="n">valid_nodes</span><span class="p">,</span> <span class="n">test_nodes</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_nodes_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">train_nodes</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_nodes_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">valid_nodes</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_nodes_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">test_nodes</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_features_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_labels_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="c1"># update dataset yaml</span>
        <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_train</span> <span class="o">=</span> <span class="n">train_nodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_valid</span> <span class="o">=</span> <span class="n">valid_nodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_test</span> <span class="o">=</span> <span class="n">test_nodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataset_stats</span><span class="o">.</span><span class="n">node_feature_dim</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">40</span>

        <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_train</span> <span class="o">+</span> <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_valid</span> <span class="o">+</span> <span class="n">dataset_stats</span><span class="o">.</span><span class="n">num_test</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;dataset.yaml&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml_file</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">dataset_stats</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">)</span>

        <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># initialize and preprocess dataset</span>
    <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;datasets/custom_nc_example/cora/&quot;</span><span class="p">)</span> <span class="c1"># note that we write to this directory</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">MYDATASET</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dataset_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;edges/train_edges.bin&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>
</pre></div>
</div>
<p>We preprocess the Cora dataset by running the ollowing command (assuming we are in the <code class="docutils literal notranslate"><span class="pre">marius</span></code> root directory):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python datasets/custom_nc_example/custom_nc_graphsage.py
 Downloading cora.tgz to cora/cora.tgz
 Reading edges
 Remapping Edges
 Node mapping written to: cora/nodes/node_mapping.txt
 Dataset statistics written to: cora/dataset.yaml
</pre></div>
</div>
<p>In this example, assume we have not created the <code class="docutils literal notranslate"><span class="pre">datasets/custom_nc_example/cora/</span></code> repository, <code class="docutils literal notranslate"><span class="pre">custom_nc_graphsage.py</span></code> will create it for us.</p>
<p>For detailed usages of Marius python API, please refer to (link).</p>
<p>Let’s check what is inside the created directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ls -1 datasets/custom_nc_example/cora/
dataset.yaml                       <span class="c1"># input dataset statistics</span>
nodes/
  node_mapping.txt                 <span class="c1"># mapping of raw node ids to integer uuids</span>
  features.bin                     <span class="c1"># preprocessed features list</span>
  labels.bin                       <span class="c1"># preprocessed labels list</span>
  test_nodes.bin                   <span class="c1"># preprocessed testing nodes list</span>
  train_nodes.bin                  <span class="c1"># preprocessed training nodes list</span>
  validation_nodes.bin             <span class="c1"># preprocessed validation nodes list</span>
edges/
  train_edges.bin                  <span class="c1"># mapping of raw edge(relation) ids to integer uuids</span>
cora/                              <span class="c1"># downloaded source files</span>
  ...
edge.csv                           <span class="c1"># raw edge list</span>
train.csv                          <span class="c1"># raw training edge list</span>
test.csv                           <span class="c1"># raw testing edge list</span>
valid.csv                          <span class="c1"># raw validation edge list</span>
node-feat.csv                      <span class="c1"># node features</span>
node-label.csv                     <span class="c1"># node labels</span>
cora.tgz                           <span class="c1"># downloaded Cora dataset</span>
</pre></div>
</div>
<p>Let’s check what is inside the generated <code class="docutils literal notranslate"><span class="pre">dataset.yaml</span></code> file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat datasets/ogbn_arxiv_example/dataset.yaml
 dataset_dir: /marius-internal/datasets/custom_nc_example/cora/
 num_edges: <span class="m">5429</span>
 num_nodes: <span class="m">2708</span>
 num_relations: <span class="m">1</span>
 num_train: <span class="m">2166</span>
 num_valid: <span class="m">270</span>
 num_test: <span class="m">272</span>
 node_feature_dim: <span class="m">1433</span>
 rel_feature_dim: -1
 num_classes: <span class="m">40</span>
 initialized: <span class="nb">false</span>
</pre></div>
</div>
</section>
<section id="define-configuration-file">
<h2>2. Define Configuration File<a class="headerlink" href="#define-configuration-file" title="Permalink to this headline"></a></h2>
<p>To train a model, we need to define a YAML configuration file based on information created from the preprocessing python script.</p>
<p>The configuration file contains information including but not limited to the inputs to the model, training procedure, and hyperparameters to optimize. Given a configuration file, marius assembles a model depending on the given parameters. The configuration file is grouped up into four sections:</p>
<ul class="simple">
<li><p>Model: Defines the architecture of the model, neighbor sampling configuration, loss, and optimizer(s)</p></li>
<li><p>Storage: Specifies the input dataset and how to store the graph, features, and embeddings.</p></li>
<li><p>Training: Sets options for the training procedure and hyperparameters. E.g. batch size, negative sampling.</p></li>
<li><p>Evaluation: Sets options for the evaluation procedure (if any). The options here are similar to those in the training section.</p></li>
</ul>
<p>For the full configuration schema, please refer to <code class="docutils literal notranslate"><span class="pre">docs/config_interface</span></code>.</p>
<p>An example YAML configuration file for the Cora dataset is given in <code class="docutils literal notranslate"><span class="pre">examples/configuration/custom_nc.yaml</span></code>. Note that the <code class="docutils literal notranslate"><span class="pre">dataset_dir</span></code> is set to the preprocessing output directory, in our example, <code class="docutils literal notranslate"><span class="pre">datasets/custom_nc_example/cora/</span></code>.</p>
<p>Let’s create the same YAML configuration file for the OGBN_Arxiv dataset from scratch. We follow the structure of the configuration file and create each of the four sections one by one. In a YAML file, indentation is used to denote nesting and all parameters are in the format of key-value pairs.</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line">First, we define the <strong>model</strong>. We begin by setting all required parameters. This includes <code class="docutils literal notranslate"><span class="pre">learning_task</span></code>, <code class="docutils literal notranslate"><span class="pre">encoder</span></code>, <code class="docutils literal notranslate"><span class="pre">decoder</span></code>, and <code class="docutils literal notranslate"><span class="pre">loss</span></code>.</div>
<div class="line">Note that the output of the encoder is the output label vector for a given node. (E.g. For node classification with 5 classes, the output label vector from the encoder might look like this: [.05, .2, .8, .01, .03]. In this case, an argmax will return a class label of 2 for the node.) The rest of the configurations can be fine-tuned by the user.</div>
</div>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="nt">learning_task</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NODE_CLASSIFICATION</span> <span class="c1"># set the learning task to node classification</span>
  <span class="nt">encoder</span><span class="p">:</span>
    <span class="nt">train_neighbor_sampling</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ALL</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ALL</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ALL</span>
    <span class="nt">layers</span><span class="p">:</span> <span class="c1"># define three layers of GNN of type GRAPH_SAGE</span>
      <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FEATURE</span>
          <span class="nt">output_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1433</span> <span class="c1"># set to 1433 (to match &quot;node_feature_dim=1433&quot; in &quot;dataset.yaml&quot;) for each layer except for the last</span>
          <span class="nt">bias</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GNN</span>
          <span class="nt">options</span><span class="p">:</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GRAPH_SAGE</span>
            <span class="nt">aggregator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MEAN</span>
          <span class="nt">input_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1433</span> <span class="c1"># set to 1433 (to match &quot;node_feature_dim=1433&quot; in &quot;dataset.yaml&quot;) for each layer except for the last</span>
          <span class="nt">output_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1433</span>
          <span class="nt">bias</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GNN</span>
          <span class="nt">options</span><span class="p">:</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GRAPH_SAGE</span>
            <span class="nt">aggregator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MEAN</span>
          <span class="nt">input_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1433</span>
          <span class="nt">output_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1433</span>
          <span class="nt">bias</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GNN</span>
          <span class="nt">options</span><span class="p">:</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GRAPH_SAGE</span>
            <span class="nt">aggregator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MEAN</span>
          <span class="nt">input_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1433</span>
          <span class="nt">output_dim</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40</span> <span class="c1"># set &quot;output_dim&quot; to 40 (to match &quot;num_classes=40&quot;) in &quot;dataset.yaml&quot; for the last layer</span>
          <span class="nt">bias</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">decoder</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NODE</span>
  <span class="nt">loss</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CROSS_ENTROPY</span>
    <span class="nt">options</span><span class="p">:</span>
      <span class="nt">reduction</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SUM</span>
  <span class="nt">dense_optimizer</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ADAM</span>
    <span class="nt">options</span><span class="p">:</span>
      <span class="nt">learning_rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.01</span>
<span class="nt">storage</span><span class="p">:</span>
  <span class="c1"># omit</span>
<span class="nt">training</span><span class="p">:</span>
  <span class="c1"># omit</span>
<span class="nt">evaluation</span><span class="p">:</span>
  <span class="c1"># omit</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><div class="line-block">
<div class="line">Next, we set the <strong>storage</strong> and <strong>dataset</strong>. We begin by setting all required parameters. This includes <code class="docutils literal notranslate"><span class="pre">dataset</span></code>. Here, the <code class="docutils literal notranslate"><span class="pre">dataset_dir</span></code> is set to <code class="docutils literal notranslate"><span class="pre">datasets/custom_nc_example/cora/</span></code>, which is the preprocessing output directory.</div>
</div>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="c1"># omit</span>
<span class="nt">storage</span><span class="p">:</span>
  <span class="nt">device_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cuda</span>
  <span class="nt">dataset</span><span class="p">:</span>
    <span class="nt">dataset_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">datasets/custom_nc_example/cora/</span>
  <span class="nt">edges</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DEVICE_MEMORY</span>
    <span class="nt">options</span><span class="p">:</span>
      <span class="nt">dtype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">int</span>
  <span class="nt">features</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DEVICE_MEMORY</span>
    <span class="nt">options</span><span class="p">:</span>
      <span class="nt">dtype</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">float</span>
<span class="nt">training</span><span class="p">:</span>
  <span class="c1"># omit</span>
<span class="nt">evaluation</span><span class="p">:</span>
  <span class="c1"># omit</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Lastly, we configure <strong>training</strong> and <strong>evaluation</strong>. We begin by setting all required parameters. This includes <code class="docutils literal notranslate"><span class="pre">num_epochs</span></code>. We set <code class="docutils literal notranslate"><span class="pre">num_epochs=10</span></code> (10 epochs to train) to demonstrate this example.</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="c1"># omit</span>
<span class="nt">storage</span><span class="p">:</span>
  <span class="c1"># omit</span>
<span class="nt">training</span><span class="p">:</span>
  <span class="nt">batch_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
  <span class="nt">num_epochs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
  <span class="nt">pipeline</span><span class="p">:</span>
    <span class="nt">sync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">evaluation</span><span class="p">:</span>
  <span class="nt">batch_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
  <span class="nt">pipeline</span><span class="p">:</span>
    <span class="nt">sync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</section>
<section id="train-model">
<h2>3. Train Model<a class="headerlink" href="#train-model" title="Permalink to this headline"></a></h2>
<p>After defining our configuration file, training is run with <code class="docutils literal notranslate"><span class="pre">marius_train</span> <span class="pre">&lt;your_config.yaml&gt;</span></code>.</p>
<p>We can now train our example using the configuration file we just created by running the following command (assuming we are in the <code class="docutils literal notranslate"><span class="pre">marius</span></code> root directory):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ marius_train datasets/custom_nc_example/cora/custom_nc.yaml
 <span class="o">[</span><span class="m">2022</span>-04-05 <span class="m">18</span>:41:44.987<span class="o">]</span> <span class="o">[</span>info<span class="o">]</span> <span class="o">[</span>marius.cpp:45<span class="o">]</span> Start initialization
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.122<span class="o">]</span> Initialization Complete: <span class="m">4</span>.134s
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.135<span class="o">]</span> <span class="c1">################ Starting training epoch 1 ################</span>
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.161<span class="o">]</span> Nodes processed: <span class="o">[</span><span class="m">1000</span>/2166<span class="o">]</span>, <span class="m">46</span>.17%
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.180<span class="o">]</span> Nodes processed: <span class="o">[</span><span class="m">2000</span>/2166<span class="o">]</span>, <span class="m">92</span>.34%
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.199<span class="o">]</span> Nodes processed: <span class="o">[</span><span class="m">2166</span>/2166<span class="o">]</span>, <span class="m">100</span>.00%
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.199<span class="o">]</span> <span class="c1">################ Finished training epoch 1 ################</span>
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.199<span class="o">]</span> Epoch Runtime: 63ms
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.199<span class="o">]</span> Nodes per Second: <span class="m">34380</span>.953
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.199<span class="o">]</span> Evaluating validation <span class="nb">set</span>
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.213<span class="o">]</span>
 <span class="o">=================================</span>
 Node Classification: <span class="m">270</span> nodes evaluated
 Accuracy: <span class="m">12</span>.962963%
 <span class="o">=================================</span>
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.213<span class="o">]</span> Evaluating <span class="nb">test</span> <span class="nb">set</span>
 <span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.221<span class="o">]</span>
 <span class="o">=================================</span>
 Node Classification: <span class="m">272</span> nodes evaluated
 Accuracy: <span class="m">16</span>.176471%
 <span class="o">=================================</span>
</pre></div>
</div>
<p>After running this configuration for 10 epochs, we should see a result similar to below with arruracy roughly equal to 86%:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">=================================</span>
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.820<span class="o">]</span> <span class="c1">################ Starting training epoch 10 ################</span>
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.833<span class="o">]</span> Nodes processed: <span class="o">[</span><span class="m">1000</span>/2166<span class="o">]</span>, <span class="m">46</span>.17%
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.854<span class="o">]</span> Nodes processed: <span class="o">[</span><span class="m">2000</span>/2166<span class="o">]</span>, <span class="m">92</span>.34%
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.872<span class="o">]</span> Nodes processed: <span class="o">[</span><span class="m">2166</span>/2166<span class="o">]</span>, <span class="m">100</span>.00%
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.872<span class="o">]</span> <span class="c1">################ Finished training epoch 10 ################</span>
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.872<span class="o">]</span> Epoch Runtime: 51ms
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.872<span class="o">]</span> Nodes per Second: <span class="m">42470</span>.59
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.872<span class="o">]</span> Evaluating validation <span class="nb">set</span>
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.883<span class="o">]</span>
<span class="o">=================================</span>
Node Classification: <span class="m">270</span> nodes evaluated
Accuracy: <span class="m">84</span>.814815%
<span class="o">=================================</span>
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.883<span class="o">]</span> Evaluating <span class="nb">test</span> <span class="nb">set</span>
<span class="o">[</span><span class="m">04</span>/05/22 <span class="m">18</span>:41:49.891<span class="o">]</span>
<span class="o">=================================</span>
Node Classification: <span class="m">272</span> nodes evaluated
Accuracy: <span class="m">88</span>.970588%
<span class="o">=================================</span>
</pre></div>
</div>
<p>Let’s check again what was added in the <code class="docutils literal notranslate"><span class="pre">datasets/custom_nc_example/cora/</span></code> directory. For clarity, we only list the files that were created in training. Notice that several files have been created, including the trained model, the embedding table, a full configuration file, and output logs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ls -1 datasets/ogbn_arxiv_example/
model.pt                           <span class="c1"># contains the dense model parameters, including the GNN parameters</span>
model_state.pt                     <span class="c1"># optimizer state of the trained model parameters</span>
full_config.yaml                   <span class="c1"># detailed config generated based on user-defined config</span>
metadata.csv                       <span class="c1"># information about metadata</span>
logs/                              <span class="c1"># logs containing output, error, debug information, and etc.</span>
nodes/
  ...
edges/
  ...
...
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">model.pt</span></code> contains the dense model parameters. For GNN encoders, this file will include the GNN parameters.</p>
</div>
</section>
<section id="inference">
<h2>4. Inference<a class="headerlink" href="#inference" title="Permalink to this headline"></a></h2>
<section id="command-line">
<h3>4.1 Command Line<a class="headerlink" href="#command-line" title="Permalink to this headline"></a></h3>
</section>
<section id="load-into-python">
<h3>4.2 Load Into Python<a class="headerlink" href="#load-into-python" title="Permalink to this headline"></a></h3>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="nc_ogbn_arxiv.html" class="btn btn-neutral float-left" title="Small Scale Node Classification (OGBN-Arxiv)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../python/index.html" class="btn btn-neutral float-right" title="Python Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>